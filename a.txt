# MyController.java
package com.example.medicineReminder.controller;

import com.example.medicineReminder.domain.PrincipalDetails;
import com.example.medicineReminder.domain.AppUser;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class MyController {

    @GetMapping("/my-info")
    public String getMyInfo(@AuthenticationPrincipal PrincipalDetails principalDetails) {
        // @AuthenticationPrincipal ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì„¸ì…˜ì— ì €ì¥ëœ PrincipalDetails ê°ì²´ë¥¼ ë°”ë¡œ ì£¼ì…ë°›ìŒ

        // ìš°ë¦¬ ì„œë¹„ìŠ¤ì˜ User ê°ì²´ë¥¼ êº¼ë‚´ì„œ ì‚¬ìš©
        AppUser user = principalDetails.getUser();

        Long myInternalId = user.getId(); // ìš°ë¦¬ DBì˜ user_id
        String myNickname = user.getNickname();

        return "ë‚´ë¶€ ID: " + myInternalId + ", ë‹‰ë„¤ì„: " + myNickname;
    }
}
---
# SwaggerConfig.java
package com.example.medicineReminder.config;

import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.security.OAuthFlow;
import io.swagger.v3.oas.models.security.OAuthFlows;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SwaggerConfig
{
    // application.yml/properties íŒŒì¼ì—ì„œ OAuth2 ê³µê¸‰ìì˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    @Value("${spring.security.oauth2.client.provider.kakao.authorization-uri}")
    private String authorizationUri;

    @Value("${spring.security.oauth2.client.provider.kakao.token-uri}")
    private String tokenUri;

    // ì˜ˆì‹œ: provider-nameì€ google, kakao ë“± application.ymlì— ì„¤ì •í•œ ê°’ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.

    @Bean
    public OpenAPI openAPI()
    {
        Info info = new Info()
                .title("ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ API")
                .version("v1.0.0")
                .description("APIì— ëŒ€í•œ ì„¤ëª…ì…ë‹ˆë‹¤.");

        String securitySchemeName = "OAuth 2.0";

        SecurityRequirement securityRequirement = new SecurityRequirement().addList(securitySchemeName);

        Components components = new Components()
                .addSecuritySchemes(securitySchemeName, new SecurityScheme()
                        .name(securitySchemeName)
                        .type(SecurityScheme.Type.OAUTH2) // íƒ€ì…ì„ OAUTH2ë¡œ ë³€ê²½
                        .flows(new OAuthFlows()
                                .authorizationCode(new OAuthFlow() // Authorization Code Grant Flow ì‚¬ìš©
                                                .authorizationUrl(authorizationUri) // ì¸ì¦ URL
                                                .tokenUrl(tokenUri) // í† í° ìš”ì²­ URL
                                        // í•„ìš”í•œ ìŠ¤ì½”í”„ë¥¼ ì—¬ê¸°ì— ì¶”ê°€
                                        // .scopes(new Scopes().addString("read", "ì½ê¸° ê¶Œí•œ").addString("write", "ì“°ê¸° ê¶Œí•œ"))
                                )
                        )
                );

        return new OpenAPI()
                .info(info)
                .addSecurityItem(securityRequirement)
                .components(components);

    }
}

---

# SecurityConfig.java
package com.example.medicineReminder.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.web.SecurityFilterChain;
import com.example.medicineReminder.service.CustomOAuth2UserService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final CustomOAuth2UserService customOAuth2UserService;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                // 1. ğŸš¨ CORS ì„¤ì • í™œì„±í™”
                .cors(Customizer.withDefaults())
                // CSRF ë¹„í™œì„±í™” (API ì„œë²„ì˜ ì¼ë°˜ì ì¸ ì„¤ì •)
                .csrf(AbstractHttpConfigurer::disable)

                .authorizeHttpRequests(authorize -> authorize
                        // Swagger UI ê²½ë¡œ ì ‘ê·¼ í—ˆìš©
                        .requestMatchers("/swagger-ui/**", "/v3/api-docs/**").permitAll()
                        // ë£¨íŠ¸ ê²½ë¡œì™€ ë¡œê·¸ì¸ ê²½ë¡œëŠ” ëª¨ë‘ í—ˆìš©
                        .requestMatchers("/", "/login").permitAll()
                        .anyRequest().authenticated() // ê·¸ ì™¸ì˜ ëª¨ë“  ìš”ì²­ì€ ì¸ì¦ í•„ìš”
                )
                .oauth2Login(oauth2 -> oauth2
                        .userInfoEndpoint(userInfo -> userInfo
                                // ë¡œê·¸ì¸ ì„±ê³µ í›„ ì²˜ë¦¬ëŠ” ìš°ë¦¬ê°€ ë§Œë“  customOAuth2UserServiceë¥¼ ì‚¬ìš©í•˜ë¼ê³  ì§€ì •
                                .userService(customOAuth2UserService)
                        )
                );

        return http.build();
    }

    // 2. ğŸš¨ CORS êµ¬ì²´ì  ì„¤ì • Bean ì •ì˜
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();

        // ğŸ”‘ í”„ë¡ íŠ¸ì—”ë“œ ì£¼ì†Œ(localhost:63342)ë¥¼ í—ˆìš© ëª©ë¡ì— ì¶”ê°€
        configuration.setAllowedOrigins(Arrays.asList("http://localhost:63342"));

        // í•„ìš”í•œ HTTP ë©”ì„œë“œ í—ˆìš©
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));

        // ì¸ì¦ ì •ë³´(ì„¸ì…˜, Authorization í—¤ë” ë“±) ì „ì†¡ í—ˆìš©
        configuration.setAllowCredentials(true);

        // ëª¨ë“  í—¤ë”ë¥¼ í—ˆìš© (Authorization í—¤ë”ë¥¼ í¬í•¨í•˜ê¸° ìœ„í•¨)
        configuration.setAllowedHeaders(Arrays.asList("*"));

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration); // ëª¨ë“  API ê²½ë¡œì— CORS ê·œì¹™ ì ìš©
        return source;
    }
}

--- 

# FirebaseConfig.java
package com.example.medicineReminder.config;

import com.google.auth.oauth2.GoogleCredentials;
import com.google.firebase.FirebaseApp;
import com.google.firebase.FirebaseOptions;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;

import jakarta.annotation.PostConstruct;
import java.io.ByteArrayInputStream;
import java.io.FileInputStream;
import java.nio.charset.StandardCharsets;
import java.util.List;

@Configuration
public class FirebaseConfig {

    @Value("${reminder.fcm.enabled:true}")
    private boolean enabled;

    @Value("${reminder.fcm.useGoogleCredentialsPath:true}")
    private boolean useGooglePath;

    @Value("${reminder.fcm.jsonEnvKey:FIREBASE_CREDENTIALS_JSON}")
    private String jsonEnvKey;

    @PostConstruct
    public void init() {
        if (!enabled) return;
        try {
            if (FirebaseApp.getApps() != null && !FirebaseApp.getApps().isEmpty()) return;

            FirebaseOptions options;
            if (useGooglePath) {
                // GOOGLE_APPLICATION_CREDENTIALS í™˜ê²½ë³€ìˆ˜ ê²½ë¡œ ì‚¬ìš©
                options = FirebaseOptions.builder()
                        .setCredentials(GoogleCredentials.getApplicationDefault())
                        .build();
            } else {
                // ì„œë¹„ìŠ¤ê³„ì • JSONì„ í™˜ê²½ë³€ìˆ˜ì— ê·¸ëŒ€ë¡œ ë‹´ì•„ë‘” ê²½ìš°
                String json = System.getenv(jsonEnvKey);
                if (json == null || json.isBlank()) throw new IllegalStateException("FCM JSON env not found: " + jsonEnvKey);
                ByteArrayInputStream bais = new ByteArrayInputStream(json.getBytes(StandardCharsets.UTF_8));
                options = FirebaseOptions.builder()
                        .setCredentials(GoogleCredentials.fromStream(bais))
                        .build();
            }
            FirebaseApp.initializeApp(options);
        } catch (Exception ignore) {
            // ìˆ˜ì—… ë²”ìœ„: ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œì—ë„ ì•±ì€ êµ¬ë™. ì‹¤ì œ ë°œì†¡ì€ ì‹¤íŒ¨ë¡œ ê¸°ë¡ë¨.
        }
    }
}

# DbProbeRunner.java
package com.example.medicineReminder.config;

import org.springframework.boot.CommandLineRunner;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

@Component
public class DbProbeRunner implements CommandLineRunner
{
    private final JdbcTemplate jdbc;

    public DbProbeRunner(JdbcTemplate jdbc)
    {
        this.jdbc = jdbc;
    }

    @Override
    public void run(String... args)
    {
        try
        {
            String db = jdbc.queryForObject("SELECT DATABASE()", String.class);
            Integer users = jdbc.queryForObject("SELECT COUNT(*) FROM AppUsers", Integer.class);
            Integer meds = jdbc.queryForObject("SELECT COUNT(*) FROM UserMedications", Integer.class);
            Integer schedules = jdbc.queryForObject("SELECT COUNT(*) FROM IntakeSchedules", Integer.class);
            System.out.println("[DB-PROBE] database=" + db +
                    " users=" + users + " meds=" + meds + " schedules=" + schedules);
        }
        catch (Exception e)
        {
            System.out.println("[DB-PROBE] failed: " + e.getMessage());
        }
    }
}




